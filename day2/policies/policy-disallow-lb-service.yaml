apiVersion: policy.open-cluster-management.io/v1 
kind: Policy 
metadata: 
  name: policy-gatekeeper-disable-lb-service 
  annotations: 
    policy.open-cluster-management.io/standards: NIST SP 800-53 
    policy.open-cluster-management.io/categories: CM Configuration Management 
    policy.open-cluster-management.io/controls: CM-2 Baseline Configuration 
spec: 
  remediationAction: enforce 
  disabled: false 
  policy-templates: 
    - objectDefinition: 
           apiVersion: policy.open-cluster-management.io/v1 
           kind: ConfigurationPolicy 
           metadata: 
               name: policy-gatekeeper-disable-lb-service 
           spec: 
               remediationAction: enforce 
               severity: low 
               object-templates: 
                 - complianceType: musthave 
                   objectDefinition: 
                     apiVersion: templates.gatekeeper.sh/v1 
                     kind: ConstraintTemplate 
                     metadata: 
                        name: k8sblockloadbalancer 
                        annotations: 
                            metadata.gatekeeper.sh/title: "Block Services with type LoadBalancer" 
                            metadata.gatekeeper.sh/version: 1.0.0 
                            description: >- 
                                Disallows all Services with type LoadBalancer. 
 
                                https://kubernetes.io/docs/concepts/services-networking/service/#loadbalancer 
                     spec: 
                       crd: 
                         spec: 
                           names: 
                             kind: K8sBlockLoadBalancer 
                       targets: 
                         - target: admission.k8s.gatekeeper.sh 
                           rego: | 
                             package k8sblockloadbalancer 
 
                             violation[{"msg": msg}] { 
                               input.review.kind.kind == "Service" 
                               input.review.object.spec.type == "LoadBalancer" 
                               msg := "User is not allowed to create service of type LoadBalancer" 
                             } 

                 - complianceType: musthave 
                   objectDefinition: 
                     apiVersion: constraints.gatekeeper.sh/v1beta1 
                     kind: K8sBlockLoadBalancer 
                     metadata: 
                         name: block-load-balancer 
                     spec: 
                        match: 
                             kinds: 
                                - apiGroups: [""] 
                                  kinds: ["Service"] 
